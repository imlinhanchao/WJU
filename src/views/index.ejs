<%- include('header') %>
      <main class="flex-1 flex flex-col justify-center items-center relative">
        <span v-if="error" class="error">{{ error }}</span>
        <section v-if="current">
          <span class="text-[5em]" v-for="(t, i) in current.split('')" :key="t + i">{{ t }}</span>
        </section>
        <section v-if="!current">
          <button @click="startGame" class="bg-action-3 font-bold py-2 px-4 rounded">
            <span>å¼€å§‹æ¸¸æˆ</span>
            <% if(locals.user){ -%><span>(<%=locals.query.difficulty ? 200 : 100 %> points)</span><% } -%>
          </button>
        </section>
        <section v-else class="text-4xl font-silk">
          {{ current == matchText ? '==' : '!='}}
        </section>
        <section v-if="current" class="whitespace-pre-wrap w-full text-center px-5 break-all">
          <span 
            class="text-[3em]" 
            :class="{ 'text-blue-500': t != '_', 'text-gray-500': t == '_' }" 
            v-for="(t, i) in matchText.split('')" 
            :key="t + i">
            {{ t }}
          </span>
        </section>
        <section v-if="current && current !== matchText" class="flex items-center justify-center">
          <button 
            @click="revoke" 
            aria-label="æ’¤å›æ“ä½œ"
            :disabled="!history.length"
            class="font-bold py-2 px-4 rounded m-2 font-mono text">
            <span>â†©</span>
            <% if(locals.user){ -%><span>(10 points)</span><% } -%>
          </button>
          <button 
            @click="startGame" 
            aria-label="é‡æ–°å¼€å§‹"
            class="font-bold py-2 px-4 rounded m-2 font-mono text">
            <span>â†»</span>
            <% if(locals.user){ -%><span>(<%=locals.query.difficulty ? 200 : 100 %> points)</span><% } -%>
          </button>
        </section>
        <% if(locals.user) { %>
        <span v-if="isWin">
          ğŸ‰ ä½ å·²å®Œæˆä»Šå¤©çš„æŒ‘æˆ˜ï¼è·å¾— {{ earnPoint }} ç§¯åˆ†ã€‚ğŸ‰
        </span>
        <% } else { -%>
        <span v-if="isWin" class="mt-20">
          ğŸ‰ æ­å–œä½ ï¼å…±ä½¿ç”¨äº†{{history.length}}æ­¥å®Œæˆäº†æ¨å¯¼ï¼ğŸ‰
        </span>
        <p v-if="isWin">
          <button 
            @click="startGame" 
            aria-label="é‡æ–°å¼€å§‹"
            class="font-bold py-2 px-4 rounded m-2 font-mono text">
            <span>â†»</span> å†æ¥ä¸€å±€ï¼
          </button>
        </p>
        <% } -%>
        <% if (locals.query.difficulty) { %>
        <p v-if="difficulty" class="mt-4 text-sm italic text-[var(--btn-disabled-bg-color)]">
          * å½“å‰éš¾åº¦ï¼š{{ difficulty }}
        </p>
        <% } %>
        <section v-if="current && !isWin" class="space-x-1 absolute bottom-[1em] gap-2 flex flex-wrap items-center justify-center">
          <button 
            @click="addJ" 
            class="bg-action-1 font-bold py-2 px-4 rounded" 
            :disabled="!canAddJ">
            + J
          </button>
          <button 
            @click="addU" 
            class="bg-action-2 font-bold py-2 px-4 rounded" 
            :disabled="!canAddU">
            + U
          </button>
          <button
            @click="double" 
            class="bg-action-3 font-bold py-2 px-4 rounded">
            Wx => Wxx
          </button>
          <button
            @click="lessJ" 
            class="bg-action-4 font-bold py-2 px-4 rounded" 
            :disabled="!canLessJ">
            JJJ => U
          </button>
          <button
            @click="lessU" 
            class="bg-action-5 font-bold py-2 px-4 rounded"
            :disabled="!canLessU">
            UUU => J
          </button>
        </section>
      </main>
    </section>
  </section>
  <script>
    window.gamData = {
      <% if (locals.query.difficulty) { %>difficulty: <%- JSON.stringify(locals.difficulty || null) %>, <% } %>
      matchText: '<%= locals.matchText %>',
      target: '<%= locals.target %>',
      current: '<%= locals.current %>',
      history: <%- JSON.stringify(locals.history || []) %>,
      earnedPoint: <%- JSON.stringify(locals.earnedPoint || 0) %>,
    };
    window.player = <%- JSON.stringify(locals.user || null) %>;
    if (!window.player) {
      const savedData = localStorage.getItem('gameData');
      if (savedData) {
        try {
          const gameData = JSON.parse(savedData);
          if (gameData.current && gameData.target)
            window.gamData = gameData;
        } catch (e) {
          console.error('Failed to parse saved game data:', e);
        }
      }
    }
  </script>
<%- include('footer') %>
