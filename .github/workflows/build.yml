name: Deploy To Server

on:
  workflow_dispatch:
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies and build
      run: |
        npm ci
        npm run build
        cd dist
        npm ci --prod
        cd ..

    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        source: "dist/*"
        target: ${{ secrets.DEPLOY_PATH }}
        strip_components: 1
        tar_tmp_path: /tmp/
    
    - name: Execute remote deployment script
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          #!/bin/bash
          set -e  # å¤±è´¥æ—¶é€€å‡º

          source ~/.profile

          echo $PATH
          
          # å®šä¹‰æœåŠ¡åç§°
          SERVICE_NAME="wju"
          
          # æ£€æŸ¥ PM2 æ˜¯å¦å­˜åœ¨
          if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… PM2: npm install -g pm2"
              exit 1
          fi

          # åœ¨ç¨‹åºç›®å½•å¯åŠ¨
          cd ${{ secrets.DEPLOY_PATH }}
          
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
          if pm2 show $SERVICE_NAME &> /dev/null; then
              echo "ğŸ”„ æœåŠ¡ $SERVICE_NAME æ­£åœ¨é‡å¯..."
              pm2 restart $SERVICE_NAME
          else
              echo "ğŸ†• æœåŠ¡ $SERVICE_NAME ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
              pm2 start -n $SERVICE_NAME node -- index.js
          fi
          
          # ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
          pm2 save
          
          echo "âœ… æ“ä½œå®Œæˆï¼"
          echo "å½“å‰ PM2 æœåŠ¡åˆ—è¡¨ï¼š"
          pm2 list